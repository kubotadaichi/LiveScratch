# Live Scratch - Design Document

Scratchライクなブロック操作でAVライブコーディングができるWebアプリケーション。

## コンセプト

- 初心者はブロックを組み合わせるだけでライブコーディングを体験できる
- 上級者はブロック内部のコードを直接編集してカスタマイズできる
- Webブラウザから誰でもアクセス可能

## 技術スタック

- **フロントエンド**: React + TypeScript
- **ブロックエディタ**: Blockly
- **音声エンジン**: Tone.js（Web Audio API + サンプルのハイブリッド）
- **2Dグラフィックス**: p5.js（フェーズ2）
- **コードエディタ**: CodeMirror
- **ビルド**: Vite

## アーキテクチャ

```
ブロックエディタ（Blockly）
    ↓ ブロック → コード変換
音声DSL（JSON中間表現）
    ↓ スケジューラが解釈
Tone.js Transport（ビート同期で再生）
    ↓ フェーズ2
p5.jsキャンバス（音に反応するビジュアル）
```

## ブロック体系（音楽MVP）

### 1. ソースブロック（音を出す）
- `synth` — シンセサイザー（波形選択: sine, square, saw, triangle）
- `sampler` — サンプル再生（kick, snare, hihat 等プリセット）

### 2. パターンブロック（いつ鳴らすか）
- `beat` — ステップシーケンサー的に拍を指定（例: `x _ _ x _ _ x _`）
- `note` — 音程を指定（例: C4, E4, G4）
- `sequence` — 音程の並びを定義（例: [C4, E4, G4, E4]）

### 3. エフェクトブロック（音を加工する）
- `reverb`, `delay`, `filter`, `distortion`
- ブロックを繋げるとエフェクトチェーンになる

### 4. コントロールブロック（全体制御）
- `bpm` — テンポ設定
- `loop` — パターンをループ
- `every` — N小節ごとに変化

### 組み合わせ例
```
[loop]
  [sampler: kick] → [beat: x _ _ x _ _ x _]
  [sampler: hihat] → [beat: _ x _ x _ x _ x]
  [synth: saw] → [sequence: C3, E3, G3, E3] → [filter] → [reverb]
```

## ビート同期とスケジューリング

- `Tone.Transport` がマスタークロック
- BPMの変更は即座に反映
- ブロックの追加・変更・削除は次の小節の頭で反映

### 動作フロー
1. ユーザーがブロックを変更
2. Blocklyのchangeイベントが発火
3. ブロック → JSON中間表現に変換
4. 差分を検出
5. 次の小節の頭でTone.jsのスケジュールを更新

### JSON中間表現
```json
{
  "bpm": 120,
  "tracks": [
    {
      "source": { "type": "sampler", "sample": "kick" },
      "pattern": { "type": "beat", "steps": "x _ _ x _ _ x _" },
      "effects": []
    }
  ]
}
```

## 上級者向けコード編集モード

- ブロックをダブルクリックでコードパネルが開く（CodeMirror）
- 生成されたTone.jsコードを直接編集可能
- 編集済みブロックには「カスタム」バッジ表示
- ブロックUIからの変更時はカスタムコード上書きの警告あり
- 「リセット」で元のコードに復元可能

## UI構成

```
┌──────────────────────────────────────────┐
│  ツールバー [ ▶ Play ] [ ■ Stop ] [BPM: 120]  │
├────────────┬─────────────────────────────┤
│            │                             │
│  ブロック   │    ワークスペース             │
│  パレット   │   （Blocklyエディタ）          │
│            │                             │
│  - Source  │                             │
│  - Pattern │                             │
│  - Effect  │                             │
│  - Control │                             │
│            ├─────────────────────────────┤
│            │  コードパネル（折りたたみ）     │
│            │  （ブロックダブルクリックで開く）  │
├────────────┴─────────────────────────────┤
│  ステータスバー  [小節: 1] [再生中]          │
└──────────────────────────────────────────┘
```

## フェーズ分け

### フェーズ1（MVP）
- Blocklyベースのブロックエディタ（4カテゴリ）
- Tone.jsによるビート同期再生
- プリセットサンプル（kick, snare, hihat, clap）
- シンセ1種（波形選択可）
- エフェクト3種（reverb, delay, filter）
- コード編集パネル（CodeMirror）
- Play/Stop/BPM制御

### フェーズ2
- p5.jsによるオーディオリアクティブビジュアル
- ユーザー認証・プロジェクト保存・共有

### フェーズ3
- カスタムブロックの作成・共有
- モバイル対応
